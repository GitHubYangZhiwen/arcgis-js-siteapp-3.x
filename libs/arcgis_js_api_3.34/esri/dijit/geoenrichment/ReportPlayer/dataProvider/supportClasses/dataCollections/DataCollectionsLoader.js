// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/dataCollections/DataCollectionsLoader","esri/dijit/geoenrichment/promise/all ../GEUtil ../ReportTemplateData esri/dijit/geoenrichment/utils/CacheUtil esri/dijit/geoenrichment/utils/JsonXmlConverter esri/dijit/geoenrichment/utils/UrlUtil".split(" "),function(n,h,p,q,b,k){return{canLoad:function(){return h.canMakeRequests()},loadVariables:function(c){var d=q.get("DataCollectionsLoader"),g="*"===c.outFields,f=g?["*"]:c.outFields,
b=c.countryID+";"+c.hierarchy+";"+f.join(";")+";"+!!c.forceLowerCase;d[b]||(g||(f=f.slice(),-1===f.indexOf("id")&&f.push("id")),d[b]=h.getDataCollections(c.countryID,c.hierarchy,{f:"json",outFields:g?"*":JSON.stringify(f),suppressNullValues:!0,AddDerivativeVariables:"all"}).then(function(e){var b={dataCollections:e,idToVariableCache:{},fullNameToVariableCache:{}};e.forEach(function(e){e.data.forEach(function(a){function d(a){return c.forceLowerCase?a.toLowerCase():a}function m(a){if(g)return Object.keys(a).length;
var b=0;f.forEach(function(d){void 0!==a[d]&&b++});return b}var l=b.idToVariableCache[d(a.id)];if(!l||m(a)>m(l))b.idToVariableCache[d(a.id)]=a;b.fullNameToVariableCache[d(e.dataCollectionID+"."+a.id)]=a})});return b}));return d[b]},loadCustomDataVariables:function(c,d){d=d||{};var g={idToVariableCache:{},fullNameToVariableCache:{}};return n(c.map(function(f){var c=k.combineMulti([f.url||d.portalUrl,"sharing/rest/content/items",f.itemid,"resources/metadata.xml"]);return p.loadResource(c,f.token||k.getToken(d.portalUrl)).then(function(e){var c=
b.parseXml(e.data);e=[];var h=b.queryJson(c,"Fields")[0];h&&(e=e.concat(b.queryJson(h,"Field")));(c=b.queryJson(c,"CalculatedFields")[0])&&(e=e.concat(b.queryJson(c,"Script")));e.forEach(function(a){function b(a){return d.forceLowerCase?a.toLowerCase():a}a=a.attributes;a={id:a.Name,fullName:f.itemid+"."+a.Name,alias:a.Alias,description:a.Alias,type:"esriFieldType"+a.Type,precision:a.Precision?Number(a.Precision):void 0,vintage:a.Vintage};g.idToVariableCache[b(a.id)]=a;g.fullNameToVariableCache[b(a.fullName)]=
a})})})).then(function(){return g})}}});