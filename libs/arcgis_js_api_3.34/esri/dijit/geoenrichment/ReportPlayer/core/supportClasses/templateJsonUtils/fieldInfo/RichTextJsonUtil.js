// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil",["./utils","esri/dijit/geoenrichment/ReportPlayer/countryConfig"],function(h,m){var e={_wrapFieldInfoInRichText:function(a){return"["+a.name+"]"},_updateXMLString:function(a,b,d){return a.replace(new RegExp("\\["+b+"\\]","g"),d)},isDTagFieldInfo:function(a){return a&&(a.hasVariable||a.script||0===a.name.indexOf("headers."))}},n=/<d .*?\/>|<d\/>/,p=/<text.*?\/>/,k=/<reportname.*?\/>/i,l=
/<reporttitle2.*?\/>/i;e.createFieldInfoFromRichText=function(a,b){a=a||"";b=b||[];for(var d={},f=0;f<b.length;f++){var c=b[f],g;g="Title"===c.name&&k.test(a)?k:"Subtitle"===c.name&&l.test(a)?l:e.isDTagFieldInfo(c)?n:p;a=a.replace(g,e._wrapFieldInfoInRichText(c));d[c.name]=c}return{isRichText:!0,richTextJson:{fieldInfos:d,xmlString:a}}};e.createRichTextFromFieldInfo=function(a,b){a=a.richTextJson;var d=a.xmlString,f;for(f in a.fieldInfos)var c=a.fieldInfos[f],g=b(c),d=e._updateXMLString(d,c.name,
g||"");return d};e.updateXMLString=function(a,b){b.forEach(function(b){a.richTextJson.xmlString=e._updateXMLString(a.richTextJson.xmlString,b.nameBefore,"["+b.name+"]")})};e.addFieldInfosToRichTextFieldInfo=function(a,b,d){d=d||{};var f=a.richTextJson;a=b.map(function(a){f.fieldInfos[a.name]=a;return d.insertRendered?h.renderer.renderFieldInfoInTableCell(a).formattedValue:e._wrapFieldInfoInRichText(a)}).join(", ");var c=f.xmlString,g="number"===typeof d.insertIndex?Math.min(c.length,d.insertIndex):
c.length;b=c.substr(0,g);c=c.substr(g);d.addSpaces&&b.length&&" "!==b.charAt(b.length-1)&&(b+=" ");d.addSpaces&&c.length&&!/^(\s|\.|,|:|\))/.test(c)&&(c=" "+c);f.xmlString=b+a+c};e.replaceFieldInfoInRichTextFieldInfo=function(a,b,d){var f=a.richTextJson;f.fieldInfos[b.name]&&-1!==f.xmlString.indexOf(e._wrapFieldInfoInRichText(b))&&(delete f.fieldInfos[b.name],e.updateXMLString(a,[{nameBefore:b.name,name:d.name}]),f.fieldInfos[d.name]=d)};var q={_reCache:{},getRegExp:function(){var a=m.getCurrencySymbol();
this._reCache[a]||(this._reCache[a]=new RegExp("[\\"+a+"%]*\\[.+?\\]%*","g"));return this._reCache[a]}};e.createFieldInfoFromRenderedXMLString=function(a,b){a=e.collectFieldInfosFromRenderedXMLString(a,b);return e.createFieldInfoFromRichText(a._xmlString,a.fieldInfos)};e.collectFieldInfosFromRenderedXMLString=function(a,b){var d={};if(b)for(var f in b.fieldInfos){var c=b.fieldInfos[f];d[h.renderer.renderFieldInfoInTableCell(c).formattedValue]=c}var g=[];(b=a.match(q.getRegExp()))&&b.forEach(function(b){var c=
d[b]||h.builder.createFieldInfoFromSpecialFieldName(b.replace(/\[|\]/g,""))||h.builder.createFieldInfoFromLabel(b);c&&(g.push(c),a=a.replace(b,e.isDTagFieldInfo(c)?"\x3cd/\x3e":"\x3ctext/\x3e"))});return{fieldInfos:g,_xmlString:a}};return e});