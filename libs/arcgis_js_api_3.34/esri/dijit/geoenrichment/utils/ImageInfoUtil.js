// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/utils/ImageInfoUtil",["dojo/_base/lang","esri/dijit/geoenrichment/when","./CacheUtil","./ImageUtil","./UrlUtil"],function(l,f,m,k,n){var p=/^data:/i,h={getImageInfo:function(a,c,b){var d=b&&b.sizeLimit||1E5,g=m.get("ImageInfoUtil"),e=a+(b&&b.crossOrigin||"");g[e]||(g[e]=k.imageFromUrl(a,b).then(function(a){var b=k.imageToDataURL(a),c={dataUrl:b,contentType:k.getContentType(b),width:a.width,height:a.height};setTimeout(function(){g[e]=c});return c}));return f(g[e],function(a){a=
l.mixin({},a);c&&(a.filename=c&&c.replace(/\.\w+$/,".png").toLowerCase());return function(a){return f(h._processDataUrl(a,d),function(b){if(b&&b.dataUrl){var c=l.mixin({},a);c.dataUrl=b.dataUrl;c.width*=b.factor;c.height*=b.factor;return f(c)}return f(a)})}(a)})},ensureDataUrlForRemoveImage:function(a,c){return!a||p.test(a)?a:h.getRemoteImageDataUrl(a,c)},getRemoteImageDataUrl:function(a,c){function b(b,c){return h.getImageInfo(b?e+"?"+a:a,null,{crossOrigin:c}).then(function(a){return f(h._processDataUrl(a,
g),function(a){return a&&a.dataUrl||a})})}function d(){console.log("Failed to get data for URL: "+a);return a}if(!a)return a;var g=c&&c.sizeLimit||1E5,e=n.getProxyUrl();return b(!1,"anonymous").otherwise(function(){return b(!1,null)}).otherwise(function(){return e?b(!0,"anonymous"):d()}).otherwise(function(){return b(!0,null)}).otherwise(d)},_processDataUrl:function(a,c){var b=Math.max(a.width,a.height);if(b<=c)return a.dataUrl;var d=c/b;return f(k.scaleImage(a.dataUrl,{factor:d}),function(a){return{dataUrl:a,
factor:d}})}};return h});